name: ğŸ” Security Pipeline - ML Vulnerability Detection

on:
  pull_request:
    branches: [test]
    types: [opened, synchronize, reopened]

permissions:
  contents: read
  pull-requests: write
  issues: write
  statuses: write
  actions: write

env:
  TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
  TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}

jobs:
  security-analysis:
    name: ğŸ¤– ML Security Analysis
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: ğŸ Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: âœ… Verificar modelos ML
        run: |
          echo "ğŸ” Verificando modelos entrenados..."
          if [ ! -f ml-security/models/vulnerability_detector.pkl ]; then
            echo "âŒ Error: Modelo de detecciÃ³n no encontrado"
            exit 1
          fi
          if [ ! -f ml-security/models/cwe_classifier.pkl ]; then
            echo "âŒ Error: Modelo de clasificaciÃ³n CWE no encontrado"
            exit 1
          fi
          echo "âœ… Todos los modelos estÃ¡n disponibles"
      
      - name: ğŸ” Detectar archivos modificados
        id: changed-files
        run: |
          echo "ğŸ” Detectando archivos modificados..."
          git diff --name-only origin/test...HEAD | grep -E '\.(js|jsx|ts|tsx|py|java|cpp|c|cs|php|rb|go|kt)$' > modified_files.txt || true
          
          # Si no hay cambios, usar los directorios por defecto
          if [ ! -s modified_files.txt ]; then
            echo "ğŸ“ Analizando directorios completos (sin cambios especÃ­ficos)"
            echo "cliente/src" > modified_files.txt
            echo "servidor" >> modified_files.txt
          else
            echo "ğŸ“‹ Archivos modificados:"
            cat modified_files.txt
          fi
      
      - name: ğŸ” Escanear vulnerabilidades con ML
        id: scan
        run: |
          pip install requests numpy==2.0.0 scikit-learn==1.7.2
          chmod +x .github/scripts/scan_vulnerabilities.py
          
          # Obtener lista de archivos
          FILES=$(cat modified_files.txt | tr '\n' ' ')
          
          # Escanear archivos modificados
          if [[ "$FILES" == *"cliente"* ]] || [[ "$FILES" == *"servidor"* ]]; then
            # Si contiene directorios, usar modo directorio
            python .github/scripts/scan_vulnerabilities.py cliente/src 2>&1 || true
            python .github/scripts/scan_vulnerabilities.py servidor 2>&1 || true
          else
            # Si contiene archivos especÃ­ficos, usar modo archivos
            python .github/scripts/scan_vulnerabilities.py --files $FILES 2>&1 || true
          fi
          
          if [ -f "vulnerability_report.json" ]; then
            echo "âœ… Reporte generado"
            if grep -q '"is_safe": false' vulnerability_report.json; then
              echo "scan_status=vulnerable" >> $GITHUB_OUTPUT
              exit 1
            else
              echo "scan_status=safe" >> $GITHUB_OUTPUT
            fi
          else
            echo "âŒ Error: No se generÃ³ reporte"
            echo "scan_status=failed" >> $GITHUB_OUTPUT
            exit 1
          fi
      
      - name: ğŸ“Š Comment PR with results
        if: always()
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            try {
              const report = JSON.parse(fs.readFileSync('vulnerability_report.json', 'utf8'));
              const status = report.is_safe ? 'âœ… SEGURO' : 'âŒ VULNERABLE';
              let body = `## ${status}\n\n`;
              body += `ğŸ¤– **AnÃ¡lisis ML completado**\n`;
              body += `- Total archivos: ${report.summary?.total || 0}\n`;
              body += `- Vulnerabilidades: ${report.summary?.vulnerable || 0}\n\n`;
              
              if (!report.is_safe && report.vulnerabilities?.length > 0) {
                body += `### ğŸš¨ Top 5 Vulnerabilidades:\n\n`;
                report.vulnerabilities.slice(0, 5).forEach((v, i) => {
                  body += `${i+1}. **${v.type}** (${(v.confidence*100).toFixed(1)}%)\n`;
                  body += `   ğŸ“„ \`${v.file}:${v.line}\`\n`;
                });
                if (report.vulnerabilities.length > 5) {
                  body += `\n... y ${report.vulnerabilities.length - 5} mÃ¡s`;
                }
              } else {
                body += `âœ… **Sin vulnerabilidades detectadas**`;
              }
              
              github.rest.issues.createComment({
                issue_number: context.issue.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: body
              });
            } catch(e) {
              console.log('Error:', e);
            }
      
      - name: ğŸ“± Notificar a Telegram
        if: always()
        run: |
          pip install requests
          python .github/scripts/notify_telegram.py
        env:
          GITHUB_COMMIT_MESSAGE: ${{ github.event.pull_request.title }}
          GITHUB_ACTOR: ${{ github.actor }}
      
      - name: âŒ Fallar si hay vulnerabilidades
        if: steps.scan.outputs.scan_status == 'vulnerable'
        run: exit 1

  auto-merge-to-test:
    name: ğŸ”€ Auto Merge to Test
    needs: [security-analysis]
    runs-on: ubuntu-latest
    if: success()
    permissions:
      contents: write
      pull-requests: write
      actions: write
    
    steps:
      - name: ğŸ”€ Auto merge PR
        uses: actions/github-script@v7
        with:
          script: |
            try {
              await github.rest.pulls.merge({
                owner: context.repo.owner,
                repo: context.repo.repo,
                pull_number: context.payload.pull_request.number,
                commit_title: `ğŸ”€ Auto-merge: ${context.payload.pull_request.title}`,
                commit_message: `CÃ³digo aprobado por anÃ¡lisis ML de seguridad.`,
                merge_method: 'merge'
              });
              console.log('âœ… PR mergeado a test');
            } catch(error) {
              console.log('Error en merge:', error);
            }
      
      - name: ğŸ§ª Disparar test-pipeline
        if: success()
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.actions.createWorkflowDispatch({
              owner: context.repo.owner,
              repo: context.repo.repo,
              workflow_id: 'test-pipeline.yml',
              ref: 'test'
            });
