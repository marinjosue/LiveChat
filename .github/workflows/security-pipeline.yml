name: Vulnerability Detection Pipeline

on:
  pull_request:
    branches: [ test ]
    types: [opened, synchronize, reopened]

permissions:
  contents: write
  pull-requests: write
  issues: write

jobs:
  vulnerability-scan:
    runs-on: ubuntu-latest
    
    steps:
    - name: üì• Checkout c√≥digo
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
    
    - name: üêç Configurar Python 3.10
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'
        cache: 'pip'
    
    - name: üì¶ Instalar dependencias
      run: |
        python -m pip install --upgrade pip
        pip install scikit-learn pandas numpy requests
    
    - name: üì• Descargar modelos entrenados
      run: |
        mkdir -p models
        if [ -d "ml-security/models" ]; then
          echo "üìã Copiando modelos..."
          cp ml-security/models/*.pkl models/ 2>/dev/null || echo "‚ö†Ô∏è Algunos modelos no se encontraron"
        fi
    
    - name: üîç Analizar c√≥digo con modelo ML
      run: python .github/scripts/scan_vulnerabilities.py
      continue-on-error: true
    
    - name: üìä Publicar reporte de vulnerabilidades
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: vulnerability-report
        path: vulnerability_report.json
        retention-days: 30
    
    - name: üì± Notificar a Telegram
      if: always()
      run: python .github/scripts/notify_telegram.py
      env:
        TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
        TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
        GITHUB_COMMIT_MESSAGE: ${{ github.event.pull_request.title || 'Sin mensaje' }}
        GITHUB_ACTOR: ${{ github.actor }}
      continue-on-error: true
    
    - name: ‚ùå Verificar vulnerabilidades
      id: check_vuln
      run: python .github/scripts/check_vulnerabilities.py
      continue-on-error: true
    
    - name: üè∑Ô∏è Etiquetar si hay vulnerabilidades
      if: steps.check_vuln.outcome == 'failure'
      uses: actions/github-script@v7
      with:
        script: |
          try {
            const prNumber = context.payload.pull_request.number;
            await github.rest.issues.addLabels({
              issue_number: prNumber,
              owner: context.repo.owner,
              repo: context.repo.repo,
              labels: ['fixing-required']
            });
          } catch (e) { }
    
    - name: ‚úÖ Auto-merge si pasa seguridad
      if: steps.check_vuln.outcome == 'success'
      run: |
        git config user.name "github-actions[bot]"
        git config user.email "github-actions[bot]@users.noreply.github.com"
        git fetch origin test
        git checkout test
        git merge --squash origin/${{ github.head_ref }}
        git commit -m "merge: auto PR ${{ github.event.pull_request.number }}"
        git push origin test
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      continue-on-error: true


