name: ğŸš« Block Invalid PR Flow

on:
  pull_request:
    branches: [main]
    types: [opened, synchronize, reopened]

permissions:
  pull-requests: write
  issues: write

env:
  TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
  TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}

jobs:
  validate-pr-flow:
    name: ğŸ” Validate PR Flow
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ” Check source branch
        id: check
        run: |
          SOURCE_BRANCH="${{ github.head_ref }}"
          TARGET_BRANCH="${{ github.base_ref }}"
          
          echo "Source: $SOURCE_BRANCH"
          echo "Target: $TARGET_BRANCH"
          
          if [ "$SOURCE_BRANCH" = "dev" ] && [ "$TARGET_BRANCH" = "main" ]; then
            echo "invalid_flow=true" >> $GITHUB_OUTPUT
            echo "âŒ FLUJO INVÃLIDO: dev â†’ main NO estÃ¡ permitido"
          elif [ "$SOURCE_BRANCH" = "test" ] && [ "$TARGET_BRANCH" = "main" ]; then
            echo "invalid_flow=false" >> $GITHUB_OUTPUT
            echo "âœ… FLUJO VÃLIDO: test â†’ main"
          elif [ "$TARGET_BRANCH" = "main" ]; then
            echo "invalid_flow=true" >> $GITHUB_OUTPUT
            echo "âŒ FLUJO INVÃLIDO: Solo test â†’ main estÃ¡ permitido"
          fi
      
      - name: ğŸ·ï¸ Label invalid flow
        if: steps.check.outputs.invalid_flow == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.issues.addLabels({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              labels: ['invalid-flow', 'blocked']
            });
      
      - name: ğŸ’¬ Comment on invalid PR
        if: steps.check.outputs.invalid_flow == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const body = `## ğŸš« FLUJO DE TRABAJO INVÃLIDO
            
            âŒ **Este Pull Request no sigue el flujo obligatorio.**
            
            ### ğŸ“‹ Flujo Requerido:
            
            \`\`\`
            dev â†’ test â†’ main
            \`\`\`
            
            ### âŒ Tu PR intenta:
            \`\`\`
            ${{ github.head_ref }} â†’ ${{ github.base_ref }}
            \`\`\`
            
            ### âœ… Pasos Correctos:
            
            1. **Cierra este PR** âŒ
            2. **Crea un PR:** \`dev\` â†’ \`test\`
            3. **Espera validaciÃ³n ML** (automÃ¡tica)
            4. **Si es seguro:** Merge automÃ¡tico a \`test\`
            5. **Tests automÃ¡ticos** se ejecutan en \`test\`
            6. **Si pasan:** Se crea PR automÃ¡tico \`test\` â†’ \`main\`
            7. **Mergea ese PR** para desplegar a producciÃ³n
            
            ### ğŸ”’ Â¿Por quÃ© este flujo?
            
            - **Seguridad:** CÃ³digo pasa por anÃ¡lisis ML primero
            - **Calidad:** Tests se ejecutan en ambiente de staging
            - **Trazabilidad:** Cada etapa queda documentada
            - **AutomatizaciÃ³n:** Merges y PRs se crean automÃ¡ticamente
            
            ### ğŸ“š DocumentaciÃ³n
            
            Lee el flujo completo en: [\`.github/FLUJO_PIPELINE.md\`](https://github.com/${{ github.repository }}/blob/dev/.github/FLUJO_PIPELINE.md)
            
            ---
            
            ğŸ¤– *Este PR serÃ¡ cerrado automÃ¡ticamente. Por favor sigue el flujo correcto.*`;
            
            await github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: body
            });
      
      - name: ğŸ“± Notify invalid flow
        if: steps.check.outputs.invalid_flow == 'true'
        run: |
          MESSAGE="ğŸš« <b>FLUJO INVÃLIDO DETECTADO</b>%0A%0A"
          MESSAGE+="âŒ <b>PR Bloqueado:</b> #${{ github.event.pull_request.number }}%0A"
          MESSAGE+="ğŸ‘¤ <b>Autor:</b> @${{ github.event.pull_request.user.login }}%0A"
          MESSAGE+="ğŸ”€ <b>Intento:</b> ${{ github.head_ref }} â†’ ${{ github.base_ref }}%0A%0A"
          MESSAGE+="âš ï¸ <b>Este flujo NO estÃ¡ permitido</b>%0A%0A"
          MESSAGE+="âœ… <b>Flujo correcto:</b>%0A"
          MESSAGE+="   1ï¸âƒ£ dev â†’ test (anÃ¡lisis ML)%0A"
          MESSAGE+="   2ï¸âƒ£ test â†’ main (despuÃ©s de tests)%0A%0A"
          MESSAGE+="ğŸ“ <b>AcciÃ³n requerida:</b>%0A"
          MESSAGE+="   â€¢ Cerrar este PR%0A"
          MESSAGE+="   â€¢ Crear PR: dev â†’ test%0A%0A"
          MESSAGE+="ğŸ”— <a href='${{ github.event.pull_request.html_url }}'>Ver PR Bloqueado</a>"
          
          curl -s -X POST "https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage" \
            -d "chat_id=${TELEGRAM_CHAT_ID}" \
            -d "text=${MESSAGE}" \
            -d "parse_mode=HTML"
      
      - name: ğŸš« Close invalid PR
        if: steps.check.outputs.invalid_flow == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.pulls.update({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: context.issue.number,
              state: 'closed'
            });
            
            console.log('âŒ PR cerrado por flujo invÃ¡lido');
      
      - name: âŒ Fail workflow for invalid flow
        if: steps.check.outputs.invalid_flow == 'true'
        run: |
          echo "âŒ PIPELINE BLOQUEADO"
          echo "Este PR no sigue el flujo obligatorio: dev â†’ test â†’ main"
          echo "El PR ha sido cerrado automÃ¡ticamente"
          exit 1
      
      - name: âœ… Valid flow detected
        if: steps.check.outputs.invalid_flow == 'false'
        run: |
          echo "âœ… Flujo vÃ¡lido detectado: test â†’ main"
          echo "ğŸš€ Este PR puede continuar normalmente"
