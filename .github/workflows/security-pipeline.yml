name: ğŸ” Security Pipeline - ML Vulnerability Detection

on:
  pull_request:
    branches: [test, main]
    types: [opened, synchronize, reopened]

env:
  TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
  TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}

jobs:
  security-analysis:
    name: ğŸ¤– ML Security Analysis
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: ğŸ Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
      
      - name: ğŸ“¦ Install ML dependencies
        run: |
          cd ml-security/backend
          pip install -r requirements.txt
      
      - name: âœ… Verificar modelos ML
        run: |
          echo "ğŸ” Verificando modelos entrenados..."
          ls -lh ml-security/models/
          
          # Verificar que existan los modelos necesarios
          if [ ! -f ml-security/models/vulnerability_detector.pkl ]; then
            echo "âŒ Error: Modelo de detecciÃ³n no encontrado"
            exit 1
          fi
          
          if [ ! -f ml-security/models/cwe_classifier.pkl ]; then
            echo "âŒ Error: Modelo de clasificaciÃ³n CWE no encontrado"
            exit 1
          fi
          
          echo "âœ… Todos los modelos estÃ¡n disponibles"
          echo "ğŸ“Š MÃ©tricas del Modelo 1 (Detector):"
          cat ml-security/models/metrics_vulnerability_detector.txt
          echo ""
          echo "ğŸ“Š MÃ©tricas del Modelo 2 (Clasificador CWE):"
          cat ml-security/models/metrics_cwe_classifier.txt
      
      - name: ğŸ” Escanear vulnerabilidades con ML
        id: scan
        run: |
          echo "ğŸ” Escaneando cÃ³digo con modelos ML..."
          echo "ğŸ“Š Modelo 1: Detector binario (79.01% accuracy, 90.12% recall)"
          echo "ğŸ“Š Modelo 2: Clasificador CWE (86.94% accuracy)"
          echo ""
          
          # Hacer ejecutable el script
          chmod +x .github/scripts/scan_vulnerabilities.py
          
          # Escanear cliente
          echo "ğŸ” Analizando cliente..."
          python .github/scripts/scan_vulnerabilities.py cliente/src || CLIENTE_VULN=1
          
          # Escanear servidor
          echo ""
          echo "ğŸ” Analizando servidor..."
          python .github/scripts/scan_vulnerabilities.py servidor || SERVIDOR_VULN=1
          
          # Combinar resultados
          if [ "$CLIENTE_VULN" == "1" ] || [ "$SERVIDOR_VULN" == "1" ]; then
            echo "vulnerable=true" >> $GITHUB_OUTPUT
            echo "âŒ Se detectaron vulnerabilidades"
            exit 1
          else
            echo "vulnerable=false" >> $GITHUB_OUTPUT
            echo "âœ… CÃ³digo seguro - Sin vulnerabilidades detectadas"
          fi
      
      - name: ğŸ“¤ Upload security report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: security-report
          path: security_report.json
          retention-days: 30
      
      - name: ğŸ“± Enviar notificaciÃ³n a Telegram
        if: always()
        run: |
          pip install requests
          python .github/scripts/telegram_notify.py vulnerability_scan security_report.json || echo "âš ï¸  Error enviando notificaciÃ³n"
      
      - name: ğŸ“Š Comment PR with results
        if: always()
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const report = JSON.parse(fs.readFileSync('ml-security/security_report.json', 'utf8'));
            
            const status = report.is_safe ? 'âœ… APROBADO' : 'âŒ RECHAZADO';
            const emoji = report.is_safe ? 'ğŸŸ¢' : 'ğŸ”´';
            
            let body = `## ${emoji} AnÃ¡lisis de Seguridad ML - ${status}\n\n`;
            body += `ğŸ“Š **Resumen:**\n`;
            body += `- Total de archivos: ${report.total_files}\n`;
            body += `- Archivos seguros: ${report.secure_files}\n`;
            body += `- Archivos vulnerables: ${report.vulnerable_files}\n\n`;
            
            if (!report.is_safe) {
              body += `### ğŸš¨ Vulnerabilidades Detectadas:\n\n`;
              report.vulnerable_list.forEach(vuln => {
                body += `#### ğŸ“„ ${vuln.file}\n`;
                body += `- **Confianza:** ${(vuln.confidence * 100).toFixed(1)}%\n`;
                if (vuln.issues) {
                  vuln.issues.forEach(issue => {
                    body += `- ${issue}\n`;
                  });
                }
                body += `\n`;
              });
              body += `\nâš ï¸ **AcciÃ³n requerida:** Corregir las vulnerabilidades antes de hacer merge.\n`;
            } else {
              body += `### âœ… CÃ³digo Seguro\n\n`;
              body += `El anÃ¡lisis ML no detectÃ³ vulnerabilidades. El cÃ³digo estÃ¡ listo para merge.\n`;
            }
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: body
            });
      
      - name: ğŸ“± Send Telegram notification - Vulnerable
        if: steps.scan.outputs.vulnerable == 'true'
        run: |
          MESSAGE="ğŸ”´ ALERTA DE SEGURIDAD%0A%0A"
          MESSAGE+="Repositorio: ${{ github.repository }}%0A"
          MESSAGE+="PR: #${{ github.event.pull_request.number }}%0A"
          MESSAGE+="Autor: ${{ github.event.pull_request.user.login }}%0A"
          MESSAGE+="Rama: ${{ github.head_ref }} â†’ ${{ github.base_ref }}%0A%0A"
          MESSAGE+="âŒ VULNERABILIDADES DETECTADAS%0A"
          MESSAGE+="El cÃ³digo NO puede ser mergeado hasta que se corrijan las vulnerabilidades.%0A%0A"
          MESSAGE+="Ver reporte: ${{ github.event.pull_request.html_url }}"
          
          curl -s -X POST "https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage" \
            -d "chat_id=${TELEGRAM_CHAT_ID}" \
            -d "text=${MESSAGE}" \
            -d "parse_mode=HTML"
      
      - name: ğŸ“± Send Telegram notification - Safe
        if: steps.scan.outputs.vulnerable == 'false'
        run: |
          MESSAGE="âœ… CÃ“DIGO SEGURO%0A%0A"
          MESSAGE+="Repositorio: ${{ github.repository }}%0A"
          MESSAGE+="PR: #${{ github.event.pull_request.number }}%0A"
          MESSAGE+="Autor: ${{ github.event.pull_request.user.login }}%0A"
          MESSAGE+="Rama: ${{ github.head_ref }} â†’ ${{ github.base_ref }}%0A%0A"
          MESSAGE+="âœ… El anÃ¡lisis ML no detectÃ³ vulnerabilidades.%0A"
          MESSAGE+="El cÃ³digo puede continuar al siguiente stage.%0A%0A"
          MESSAGE+="Ver PR: ${{ github.event.pull_request.html_url }}"
          
          curl -s -X POST "https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage" \
            -d "chat_id=${TELEGRAM_CHAT_ID}" \
            -d "text=${MESSAGE}" \
            -d "parse_mode=HTML"
      
      - name: ğŸš¨ Create issue for vulnerabilities
        if: steps.scan.outputs.vulnerable == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const report = JSON.parse(fs.readFileSync('ml-security/security_report.json', 'utf8'));
            
            let body = `## ğŸ”´ Vulnerabilidades Detectadas por ML\n\n`;
            body += `**Pull Request:** #${{ github.event.pull_request.number }}\n`;
            body += `**Autor:** @${{ github.event.pull_request.user.login }}\n`;
            body += `**Rama:** ${{ github.head_ref }} â†’ ${{ github.base_ref }}\n\n`;
            body += `### ğŸ“Š Resumen\n`;
            body += `- Archivos vulnerables: ${report.vulnerable_files}\n`;
            body += `- Total de archivos: ${report.total_files}\n\n`;
            body += `### ğŸš¨ Archivos Afectados\n\n`;
            
            report.vulnerable_list.forEach((vuln, idx) => {
              body += `${idx + 1}. **${vuln.file}**\n`;
              body += `   - Confianza: ${(vuln.confidence * 100).toFixed(1)}%\n`;
              if (vuln.issues) {
                vuln.issues.forEach(issue => {
                  body += `   - ${issue}\n`;
                });
              }
              body += `\n`;
            });
            
            body += `### âš ï¸ AcciÃ³n Requerida\n`;
            body += `1. Revisar y corregir las vulnerabilidades detectadas\n`;
            body += `2. Actualizar el Pull Request con los cambios\n`;
            body += `3. El pipeline volverÃ¡ a ejecutarse automÃ¡ticamente\n\n`;
            body += `---\n`;
            body += `ğŸ¤– Detectado por: ML Vulnerability Scanner (Random Forest)\n`;
            
            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `ğŸ”´ Vulnerabilidades en PR #${{ github.event.pull_request.number }}`,
              body: body,
              labels: ['security', 'vulnerability', 'automated']
            });
      
      - name: âŒ Fail if vulnerable
        if: steps.scan.outputs.vulnerable == 'true'
        run: |
          echo "âŒ Vulnerabilidades detectadas - Pipeline fallido"
          echo "El cÃ³digo NO puede ser mergeado"
          exit 1

  unit-tests:
    name: ğŸ§ª Unit Tests
    needs: security-analysis
    runs-on: ubuntu-latest
    if: success()
    
    strategy:
      matrix:
        component: [cliente, servidor]
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4
      
      - name: ğŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
          cache-dependency-path: ${{ matrix.component }}/package-lock.json
      
      - name: ğŸ“¦ Install dependencies
        run: |
          cd ${{ matrix.component }}
          npm ci
      
      - name: ğŸ§ª Run tests
        run: |
          cd ${{ matrix.component }}
          npm test -- --coverage --watchAll=false || echo "No tests configured"
      
      - name: ğŸ“± Notify test failure
        if: failure()
        run: |
          MESSAGE="âŒ TESTS FALLIDOS%0A%0A"
          MESSAGE+="Componente: ${{ matrix.component }}%0A"
          MESSAGE+="PR: #${{ github.event.pull_request.number }}%0A"
          MESSAGE+="Ver logs: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          
          curl -s -X POST "https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage" \
            -d "chat_id=${TELEGRAM_CHAT_ID}" \
            -d "text=${MESSAGE}"

  merge-approval:
    name: âœ… Merge Approval
    needs: [security-analysis, unit-tests]
    runs-on: ubuntu-latest
    if: success() && github.base_ref == 'test'
    
    steps:
      - name: âœ… Approve merge to test
        run: |
          echo "âœ… Todos los checks pasaron"
          echo "El cÃ³digo puede ser mergeado a test"
      
      - name: ğŸ“± Notify approval
        run: |
          MESSAGE="âœ… APROBADO PARA MERGE%0A%0A"
          MESSAGE+="PR: #${{ github.event.pull_request.number }}%0A"
          MESSAGE+="Destino: ${{ github.base_ref }}%0A"
          MESSAGE+="âœ… Security: PASS%0A"
          MESSAGE+="âœ… Tests: PASS%0A%0A"
          MESSAGE+="El cÃ³digo puede ser mergeado.%0A"
          MESSAGE+="Ver PR: ${{ github.event.pull_request.html_url }}"
          
          curl -s -X POST "https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage" \
            -d "chat_id=${TELEGRAM_CHAT_ID}" \
            -d "text=${MESSAGE}"
