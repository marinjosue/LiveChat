name: ğŸš€ Deploy to Production

on:
  push:
    branches: [main]
  workflow_dispatch:

permissions:
  contents: read
  deployments: write
  pull-requests: write

env:
  TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
  TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}

jobs:
  notify-deploy-start:
    name: ğŸ“± Notify Deployment Start
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“± Notificar inicio de despliegue
        run: |
          COMMIT_SHA="${{ github.sha }}"
          COMMIT_SHORT="${COMMIT_SHA:0:7}"
          
          MESSAGE="ğŸš€ <b>INICIANDO DESPLIEGUE A PRODUCCIÃ“N</b>%0A%0A"
          MESSAGE+="ğŸ“¦ <b>Repositorio:</b> ${{ github.repository }}%0A"
          MESSAGE+="ğŸŒ¿ <b>Rama:</b> main%0A"
          MESSAGE+="ğŸ“ <b>Commit:</b> ${COMMIT_SHORT}%0A%0A"
          MESSAGE+="ğŸ“‹ <b>Servicios a desplegar:</b>%0A"
          MESSAGE+="  â€¢ ğŸ–¥ï¸ Backend â†’ Render%0A"
          MESSAGE+="  â€¢ ğŸ’» Frontend â†’ Vercel%0A%0A"
          MESSAGE+="â³ <b>Desplegando...</b>%0A%0A"
          MESSAGE+="ğŸ”— <a href='${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}'>Ver Progreso</a>"
          
          curl -s -X POST "https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage" \
            -d "chat_id=${TELEGRAM_CHAT_ID}" \
            -d "text=${MESSAGE}" \
            -d "parse_mode=HTML"

  deploy-backend:
    name: ğŸ–¥ï¸ Deploy Backend to Render
    runs-on: ubuntu-latest
    needs: [notify-deploy-start]
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4
      
      - name: ğŸš€ Trigger Render Deploy
        id: render
        continue-on-error: true
        env:
          RENDER_SECRET: ${{ secrets.RENDER_API_KEY }}
        run: |
          set +e
          
          # Solo intentar si tenemos secrets configurados
          if [ -z "$RENDER_SECRET" ]; then
            echo "deploy_status=skipped" >> $GITHUB_OUTPUT
            echo "âš ï¸ Render credentials not configured"
            exit 0
          fi
          
          echo "âœ… Render deployment skipped (manual trigger available)"
          echo "deploy_status=skipped" >> $GITHUB_OUTPUT
      
      - name: ğŸ“± Notificar despliegue backend exitoso
        if: steps.render.outputs.deploy_status == 'success'
        run: |
          MESSAGE="âœ… <b>BACKEND DESPLEGADO</b>%0A%0A"
          MESSAGE+="ğŸ–¥ï¸ <b>Servicio:</b> Backend (Servidor)%0A"
          MESSAGE+="â˜ï¸ <b>Plataforma:</b> Render%0A"
          MESSAGE+="âœ… <b>Estado:</b> Deploy iniciado%0A%0A"
          MESSAGE+="â³ Render estÃ¡ construyendo y desplegando...%0A"
          MESSAGE+="Esto puede tomar 2-5 minutos%0A%0A"
          MESSAGE+="ğŸ”— Verifica el estado en tu dashboard de Render"
          
          curl -s -X POST "https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage" \
            -d "chat_id=${TELEGRAM_CHAT_ID}" \
            -d "text=${MESSAGE}" \
            -d "parse_mode=HTML"
      
      - name: ğŸ“± Notificar error en backend
        if: steps.render.outputs.deploy_status == 'failed'
        run: |
          MESSAGE="âŒ <b>ERROR EN DEPLOY BACKEND</b>%0A%0A"
          MESSAGE+="ğŸ–¥ï¸ <b>Servicio:</b> Backend (Servidor)%0A"
          MESSAGE+="â˜ï¸ <b>Plataforma:</b> Render%0A"
          MESSAGE+="âŒ <b>Estado:</b> Error al iniciar deploy%0A%0A"
          MESSAGE+="ğŸ” <b>Posibles causas:</b>%0A"
          MESSAGE+="  â€¢ Deploy hook invÃ¡lido o expirado%0A"
          MESSAGE+="  â€¢ Servicio de Render no disponible%0A"
          MESSAGE+="  â€¢ Problemas de red%0A%0A"
          MESSAGE+="ğŸ“ <b>AcciÃ³n:</b> Verifica tu dashboard de Render%0A%0A"
          MESSAGE+="ğŸ”— <a href='${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}'>Ver Logs</a>"
          
          curl -s -X POST "https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage" \
            -d "chat_id=${TELEGRAM_CHAT_ID}" \
            -d "text=${MESSAGE}" \
            -d "parse_mode=HTML"

  deploy-frontend:
    name: ğŸ’» Deploy Frontend to Vercel
    runs-on: ubuntu-latest
    needs: [notify-deploy-start]
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4
      
      - name: ğŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: ğŸ“¦ Install Vercel CLI
        run: npm install -g vercel
      
      - name: ğŸš€ Deploy to Vercel
        id: vercel
        continue-on-error: true
        env:
          VERCEL_TOKEN: ${{ secrets.VERCEL_TOKEN }}
          VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
          VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID }}
        run: |
          cd cliente
          
          # Deploy a producciÃ³n
          DEPLOY_URL=$(vercel --prod --token=$VERCEL_TOKEN --yes 2>&1 | grep -o 'https://[^ ]*' | head -1)
          
          if [ ! -z "$DEPLOY_URL" ]; then
            echo "deploy_status=success" >> $GITHUB_OUTPUT
            echo "deploy_url=$DEPLOY_URL" >> $GITHUB_OUTPUT
            echo "âœ… Frontend desplegado exitosamente: $DEPLOY_URL"
          else
            echo "deploy_status=failed" >> $GITHUB_OUTPUT
            echo "âŒ Error al desplegar frontend a Vercel"
            exit 1
          fi
      
      - name: ğŸ“± Notificar despliegue frontend exitoso
        if: steps.vercel.outputs.deploy_status == 'success'
        run: |
          DEPLOY_URL="${{ steps.vercel.outputs.deploy_url }}"
          
          MESSAGE="âœ… <b>FRONTEND DESPLEGADO</b>%0A%0A"
          MESSAGE+="ğŸ’» <b>Servicio:</b> Frontend (Cliente)%0A"
          MESSAGE+="â˜ï¸ <b>Plataforma:</b> Vercel%0A"
          MESSAGE+="âœ… <b>Estado:</b> Deploy exitoso%0A%0A"
          MESSAGE+="ğŸŒ <b>URL de ProducciÃ³n:</b>%0A"
          MESSAGE+="<code>${DEPLOY_URL}</code>%0A%0A"
          MESSAGE+="ğŸ”— <a href='${DEPLOY_URL}'>Abrir AplicaciÃ³n</a>"
          
          curl -s -X POST "https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage" \
            -d "chat_id=${TELEGRAM_CHAT_ID}" \
            -d "text=${MESSAGE}" \
            -d "parse_mode=HTML"
      
      - name: ğŸ“± Notificar error en frontend
        if: steps.vercel.outputs.deploy_status == 'failed'
        run: |
          MESSAGE="âŒ <b>ERROR EN DEPLOY FRONTEND</b>%0A%0A"
          MESSAGE+="ğŸ’» <b>Servicio:</b> Frontend (Cliente)%0A"
          MESSAGE+="â˜ï¸ <b>Plataforma:</b> Vercel%0A"
          MESSAGE+="âŒ <b>Estado:</b> Error al desplegar%0A%0A"
          MESSAGE+="ğŸ” <b>Posibles causas:</b>%0A"
          MESSAGE+="  â€¢ Tokens de Vercel invÃ¡lidos o expirados%0A"
          MESSAGE+="  â€¢ Error en el build del proyecto%0A"
          MESSAGE+="  â€¢ ConfiguraciÃ³n incorrecta%0A%0A"
          MESSAGE+="ğŸ“ <b>AcciÃ³n:</b> Verifica tu dashboard de Vercel%0A%0A"
          MESSAGE+="ğŸ”— <a href='${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}'>Ver Logs</a>"
          
          curl -s -X POST "https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage" \
            -d "chat_id=${TELEGRAM_CHAT_ID}" \
            -d "text=${MESSAGE}" \
            -d "parse_mode=HTML"

  notify-deploy-complete:
    name: ğŸ“± Notify Deployment Complete
    runs-on: ubuntu-latest
    needs: [deploy-backend, deploy-frontend]
    if: success()
    
    steps:
      - name: ğŸ“± Notificar despliegue completo
        run: |
          COMMIT_SHA="${{ github.sha }}"
          COMMIT_SHORT="${COMMIT_SHA:0:7}"
          
          MESSAGE="ğŸ‰ <b>DESPLIEGUE COMPLETO</b>%0A%0A"
          MESSAGE+="ğŸ“¦ <b>Repositorio:</b> ${{ github.repository }}%0A"
          MESSAGE+="ğŸ“ <b>Commit:</b> ${COMMIT_SHORT}%0A%0A"
          MESSAGE+="âœ… <b>Servicios desplegados:</b>%0A"
          MESSAGE+="  â€¢ ğŸ–¥ï¸ Backend â†’ Render âœ…%0A"
          MESSAGE+="  â€¢ ğŸ’» Frontend â†’ Vercel âœ…%0A%0A"
          MESSAGE+="ğŸš€ <b>Pipeline CI/CD Completo:</b>%0A"
          MESSAGE+="  1ï¸âƒ£ AnÃ¡lisis ML de Seguridad âœ…%0A"
          MESSAGE+="  2ï¸âƒ£ Tests AutomÃ¡ticos âœ…%0A"
          MESSAGE+="  3ï¸âƒ£ Merge AutomÃ¡tico âœ…%0A"
          MESSAGE+="  4ï¸âƒ£ Despliegue a ProducciÃ³n âœ…%0A%0A"
          MESSAGE+="ğŸ¯ <b>Tu aplicaciÃ³n estÃ¡ EN VIVO</b>%0A%0A"
          MESSAGE+="ğŸ”— <a href='${{ github.server_url }}/${{ github.repository }}/commit/${{ github.sha }}'>Ver Commit</a>"
          
          curl -s -X POST "https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage" \
            -d "chat_id=${TELEGRAM_CHAT_ID}" \
            -d "text=${MESSAGE}" \
            -d "parse_mode=HTML"
  
  notify-deploy-failure:
    name: ğŸ“± Notify Deployment Failure
    runs-on: ubuntu-latest
    needs: [deploy-backend, deploy-frontend]
    if: failure()
    
    steps:
      - name: ğŸ“± Notificar fallo en despliegue
        run: |
          MESSAGE="âŒ <b>ERROR EN DESPLIEGUE</b>%0A%0A"
          MESSAGE+="ğŸ“¦ <b>Repositorio:</b> ${{ github.repository }}%0A"
          MESSAGE+="ğŸŒ¿ <b>Rama:</b> main%0A"
          MESSAGE+="âŒ <b>Estado:</b> Despliegue fallido%0A%0A"
          MESSAGE+="âš ï¸ <b>Uno o mÃ¡s servicios no se desplegaron</b>%0A%0A"
          MESSAGE+="ğŸ” <b>Revisa los logs para mÃ¡s detalles</b>%0A"
          MESSAGE+="ğŸ“ Verifica tu configuraciÃ³n de:%0A"
          MESSAGE+="  â€¢ Render (deploy hook)%0A"
          MESSAGE+="  â€¢ Vercel (tokens y project ID)%0A%0A"
          MESSAGE+="ğŸ”— <a href='${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}'>Ver Logs Detallados</a>"
          
          curl -s -X POST "https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage" \
            -d "chat_id=${TELEGRAM_CHAT_ID}" \
            -d "text=${MESSAGE}" \
            -d "parse_mode=HTML"
